Цель домашнего задания
----------------------
Создать домашнюю сетевую лабораторию. Научится менять базовые сетевые настройки  в Linux-based системах.

Описание домашнего задания
--------------------------
```
1. Скачать и развернуть Vagrant-стенд ()https://github.com/erlong15/otus-linux/tree/network
2. Построить следующую сетевую архитектуру:
Сеть office1
- 192.168.2.0/26      - dev
- 192.168.2.64/26     - test servers
- 192.168.2.128/26    - managers
- 192.168.2.192/26    - office hardware

Сеть office2
- 192.168.1.0/25      - dev
- 192.168.1.128/26    - test servers
- 192.168.1.192/26    - office hardware

Сеть central
- 192.168.0.0/28     - directors
- 192.168.0.32/28    - office hardware
- 192.168.0.64/26    - wifi
```

Итого должны получиться следующие сервера:
```
inetRouter
centralRouter
office1Router
office2Router
centralServer
office1Server
office2Server
```
Задание состоит из 2-х частей: теоретической и практической.
-----------------------------------------------------------
В теоретической части требуется: 
--------------------------------
```
Найти свободные подсети
Посчитать количество узлов в каждой подсети, включая свободные
Указать Broadcast-адрес для каждой подсети
Проверить, нет ли ошибок при разбиении
```

В практической части требуется: 
-------------------------------
```
Соединить офисы в сеть согласно логической схеме и настроить роутинг
Интернет-трафик со всех серверов должен ходить через inetRouter
Все сервера должны видеть друг друга (должен проходить ping)
У всех новых серверов отключить дефолт на NAT (eth0), который vagrant поднимает для связи
Добавить дополнительные сетевые интерфейсы, если потребуется
```
Рекомендуется использовать Vagrant + Ansible для настройки данной схемы.    

### 1. Теоретическая часть

В теоретической части нам необходимо продумать топологию сети    
Первым шагом мы рассмотрим все сети, указанные в задании. Посчитаем для них количество узлов, найдём Broadcast-адрес, проверим, нет ли ошибок при разбиении.    

Расчёты можно выполнить вручную, или воспользоваться кальулятором сетей. Для примера, посчитаем одну подсеть вручную:    

```
У нас есть сеть directors 192.168.0.0/28
192.168.0.0 — это сама сеть, 28 — это маска. Маска показывает нам, границы сети 192.168.0.0. Макска может быть записана в 2-х видах: 
1) /28
2) 255.255.255.240

Пример перевода маски /28 в формат 255.255.255.240:

Маска Ipv4-адреса — это 4 октета, т.е. 4 блока по 8 цифр (1 или 0). 
/28 — это 28 единиц с начала маски: 11111111.11111111.11111111.11110000  
Всегда при разбиении сетей, после знака / указывается количество единиц с начала маски.

11111111.11111111.11111111.11110000 — это двоичный код маски, если мы переведем данное значение в деситеричную систему счисления, то получим 255.255.255.240


Далее посчитаем количество устройств в сети: 
Количесво устройств в сети расчитывается по формуле = 232−маска−2
Таким образом, количество устройств для подсети /28 будет = 232−28−2=16−2=14

Цифра 2 вычитается, так как:
Первый адрес (192.168.0.0) — это наименование подсети, его нельзя задать устройству
Последний адрес (192.168.0.15) — это всегда broadcast-адрес. Broadcast-адрес нужен для рассылки всем устройствам сети. 
```

```
Таким образом мы можем сформировать таблицу топологии нашей сети    

Сеть  192.168.0.0/28
Маска 255.255.255.240 
Кол-во адресов 14
Первый адрес в сети 192.168.0.1
Последний адрес в сети 192.168.0.14
Broadcast — адрес 192.168.0.15
```


После создания таблицы топологии, мы можем заметить, что ошибок в задании нет, также мы сразу видим следующие свободные сети:    

![Иллюстрация к проекту](https://github.com/aleksandr1895/Otus-Administrator-Linux-Professional/blob/master/homework26_network/net/topol_Network.png)

```
192.168.0.16/28 
192.168.0.48/28
192.168.0.128/25
192.168.255.64/26
192.168.255.32/27
192.168.255.16/28
192.168.255.8/29  
192.168.255.4/30 
```
![Иллюстрация к проекту](https://github.com/aleksandr1895/Otus-Administrator-Linux-Professional/blob/master/homework26_network/net/Network.png)

Давайте рассмотрим схему:     
Знак облака означает сеть, которую необходимо будет настроить на сервере    
Значки роутеров и серверов означают хосты, которые нам нужно будет создать.    
На схеме, мы сразу можем увидеть, что нам потребуется создать дополнительно 2 сети (на схеме обозначены полужирными фиолетовыми линиями):    
Для соединения office1Router c centralRouter — 192.168.255.8/30     
Для соединения office2Router c centralRouter — 192.168.255.4/30    
На основании этой схемы мы получаем готовый список серверов. Для более подробного изучения, сделаем новые хосты с другими ОС.    

![Иллюстрация к проекту](https://github.com/aleksandr1895/Otus-Administrator-Linux-Professional/blob/master/homework26_network/net/Topologiya2.png)


Практическая часть
------------------
Настройка NAT
-------------
Для того, чтобы на всех серверах работал интернет, на сервере inetRouter должен быть настроен NAT.    
В нашем Vagrantfile он настраивается с помощью команды:    
``iptables -t nat -A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE``
При настройке NAT таким образом, правило удаляется после перезагрузки сервера.    
Для того, чтобы правила применялись после перезагрузки, в CentOS 7 нужно выполнить следующие действия:    

Установить пакеты iptables и iptables-services:    
``yum -y install iptables iptables-services``    
Добавить службу ``iptables`` в автозапуск: ``systemctl enable iptables``    
Отредактировать файл ``/etc/sysconfig/iptables:`` ``vi /etc/sysconfig/iptables``    

```
     # Generated by iptables-save v1.4.21 on Mon Jan 17 09:53:32 2022
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [37:2828]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
# Deny ping trafic
# -A INPUT -j REJECT --reject-with icmp-host-prohibited
# -A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Mon Jan 17 09:53:32 2022
# Generated by iptables-save v1.4.21 on Mon Jan 17 09:53:32 2022
*nat
:PREROUTING ACCEPT [1:161]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
COMMIT
# Completed on Mon Jan 17 09:53:32 2022
```

Данный файл содержит в себе базовые правила, которые появляются с установкой iptables.    
Обратите, пожалуйста, внимание на следующие правила:    
```
 -A INPUT -j REJECT --reject-with icmp-host-prohibited
 -A FORWARD -j REJECT --reject-with icmp-host-prohibited
```
Они запретят ``ping`` между хостами, через данный сервер.    
В данном ДЗ эти команды нужно удалить или закомментировать, чтобы они не применялись.    
Файл ``/etc/sysconfig/iptables`` не обязательно писать с нуля. Можно поступить следующим образом:    
Установить ``iptables и iptables-services``    
Запустить службу iptables    
Внести необходимые правила iptables (и удалить ненужные)    
Выполнить команду ``iptables-save > /etc/sysconfig/iptables``    
Данная команда сохранит в файл измененные правила    
Для их применения нужно перезапустить службу iptables.    
Если просто запустить команду iptables-save, то на экране консоли появится полный список всех правил, которые действуют на текущий момент. Данная команда очень удобна для поиска проблем в iptables.    

Маршрутизация транзитных пакетов (IP forward)
---------------------------------------------
Важным этапом настройки сетевой лаборатории, является маршрутизация транзитных пакетов. Если объяснить простыми словами — это возможность сервера Linux пропускать трафик через себя к другому серверу. По умолчанию эта функция отключена в Linux. Включить её можно командой:    
Посмотреть статус форвардинга можно командой: ``sysctl net.ipv4.ip_forward``    
Если параметр равен 1, то маршрутизация транзитных пакетов включена, если 0 — отключена.     
В нашей схеме необходимо включить данную маршрутизацию на всех роутерах.    

Отключение маршрута по умолчанию на интерфейсе eth0
---------------------------------------------------
При разворачивании нашего стенда Vagrant создает в каждом сервере свой интерфейс, через который у сервера появляется доступ в интернет. Отключить данный порт нельзя, так как через него Vagrant подключается к серверам. Обычно маршрут по умолчанию прописан как раз на этот интерфейс, данный маршрут нужно отключить.    
Для отключения дефолтного маршрута нужно в файле ``/etc/sysconfig/network-scripts/ifcfg-eth0`` найти строку ``DEFROUTE=yes`` и поменять её на ``DEFROUTE=no``    

Vagrant по умолчанию не добавляет строку ``DEFROUTE=yes``, поэтому нам можно просто добавить строку ``DEFROUTE=no``    
Добавление строки:     
``echo "DEFROUTE=no" >> /etc/sysconfig/network-scripts/ifcfg-eth0``    
Данное действие нужно выполнить только на CentOS-серверах ``centralRouter и centralServer``    
После удаление маршрута по умолчанию, нужно добавить дефолтный маршрут на другой порт. Делается это с помощью идентичной команды, например, команда добавления маршрута по умолчанию на сервере centralServer будет такой:    
``echo "GATEWAY=192.168.0.1" >> /etc/sysconfig/network-scripts/ifcfg-eth1``    
После внесения данных изменений нужно перезапустить сетевую службу:    
``systemctl restart network``    


Настройка статических маршрутов
-------------------------------
Для настройки статических маршрутов используется команда ``ip route``. Данная команда работает в ``Debian-based`` и ``RHEL-based`` системах.    
Давайте рассмотрим пример настройки статического маршрута на сервере ``office1Server``. Исходя из схемы мы видим, что трафик с данного сервера будет идти через ``office1Router``. ``Office1Server и office1Router`` у нас соединены через сеть managers ``(192.168.2.128/26)``. В статическом маршруте нужно указывать адрес следующего хоста. Таким образом мы должны указать на сервере ``office1Server`` маршрут, в котором доступ к любым IP-адресам у нас будет происходить через адрес ``192.168.2.129``, который расположен на сетевом интерфейсе ``office1Router``. Команда будет выглядеть так: ``ip route add 0.0.0.0/0 via 192.168.2.129``    

c office1Server проверяем на inetRouter
---------------------------------------
проходит через 3 сети
```
На office1server прописываем статические маршруты
192.168.2.128/26 Добавляем машрут по умолчанию ip route add 0.0.0.0/0 via 192.168.2.129
от office1Router до centralRouter
192.168.255.8/30 ip route add 192.168.255.8/30 via 192.168.2.129
от centralRouter до inetRouter
192.168.255.0/30 ip route add 192.168.255.0/30 via 192.168.2.129
```

![Иллюстрация к проекту](https://github.com/aleksandr1895/Otus-Administrator-Linux-Professional/blob/master/homework26_network/net/trace_office1.png)


c office2Server проверяем на inetRouter
---------------------------------------
 проходит черз 3 сети
```
На office2server прописываем статические маршруты
192.168.1.0/25  Добавляем машрут по умолчанию ip route add 0.0.0.0/0 via 192.168.1.1
от office2Router до centralRouter
192.168.255.4/30  ip route add 192.168.255.4/30 via 192.168.1.1
от centralRouter до inetRouter
192.168.255.0/30 ip route add 192.168.255.0/30 via 192.168.1.1
```

![Иллюстрация к проекту](https://github.com/aleksandr1895/Otus-Administrator-Linux-Professional/blob/master/homework26_network/net/trace_office2.png)


